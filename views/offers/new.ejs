<%- include('../partials/layout.ejs') %>

<div class="container mt-5">
    <h2 class="mb-4">Submit an Offer</h2>
    <form id="offerForm" action="/offers" method="POST">
        <!-- Hidden Inputs -->
        <input type="hidden" name="listingId" value="<%= listing._id %>">
        <input type="hidden" name="sellerId" value="<%= listing.seller._id %>">

        <!-- Section 1: Buyer and Property Information -->
        <div class="card shadow-lg mb-3">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0">1. Buyer and Property Information</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="buyerFullName" class="form-label">Buyer Full Name</label>
                        <input type="text" class="form-control" id="buyerFullName" name="buyerFullName" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="buyerEmail" class="form-label">Buyer Email</label>
                        <input type="email" class="form-control" id="buyerEmail" name="buyerEmail" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="sellerName" class="form-label">Seller Name</label>
                        <input type="text" class="form-control" id="sellerName" name="sellerName" value="<%= listing.seller.name %>" readonly>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="propertyAddress" class="form-label">Property Address</label>
                        <input type="text" class="form-control" id="propertyAddress" name="propertyAddress" value="<%= listing.address %>, <%= listing.city %>, <%= listing.state %> <%= listing.zip %>" readonly>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="propertyCounty" class="form-label">County</label>
                        <input type="text" class="form-control" id="propertyCounty" name="propertyCounty" value="<%= listing.county %>" readonly>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Property Type</label>
                        <input type="text" class="form-control" name="propertyType" 
                               value="<%= listing.propertyType ? getPropertyTypeLabel(listing.propertyType) : 'Not specified' %>" readonly>
                        <input type="hidden" name="propertyType" value="<%= listing.propertyType %>">
                      </div>
                </div>
                <div class="mb-3">
                    <label for="offerExpiration" class="form-label">Offer Expiration Date</label>
                    <input type="date" id="offerExpiration" name="offerExpiration" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="includedPersonalProperty" class="form-label">Included Personal Property</label>
                    <textarea class="form-control" id="includedPersonalProperty" name="includedPersonalProperty" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label for="excludedPersonalProperty" class="form-label">Excluded Personal Property</label>
                    <textarea class="form-control" id="excludedPersonalProperty" name="excludedPersonalProperty" rows="2"></textarea>
                </div>
            </div>
        </div>

        <!-- Section 2: Purchase Price and Financing -->
        <div class="card shadow-lg mb-3">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0">2. Purchase Price and Financing</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="offerPrice" class="form-label">Offer Price ($)</label>
                    <input type="number" class="form-control" id="offerPrice" name="offerPrice" min="0" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Financing Type</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="financingType" id="financingCash" value="cash" required>
                        <label class="form-check-label" for="financingCash">Cash</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="financingType" id="financingBank" value="bank">
                        <label class="form-check-label" for="financingBank">Lender Financing</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="financingType" id="financingSeller" value="seller">
                        <label class="form-check-label" for="financingSeller">Seller Financing</label>
                    </div>
                </div>
                <div id="bankFinancingFields" style="display:none;">
                    <div class="mb-3">
                        <label for="loanType" class="form-label">Loan Type</label>
                        <select class="form-select" name="loanType" id="loanType">
                            <option value="">Select Loan Type</option>
                            <option value="conventional">Conventional</option>
                            <option value="fha">FHA</option>
                            <option value="va">VA</option>
                            <option value="usda">USDA</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="loanAmount" class="form-label">Loan Amount ($)</label>
                        <input type="number" class="form-control" id="loanAmount" name="loanAmount">
                    </div>
                    <div class="mb-3">
                        <label for="interestRate" class="form-label">Interest Rate (%)</label>
                        <input type="number" class="form-control" id="interestRate" name="interestRate" step="0.01">
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Earnest Money -->
        <div class="card shadow-lg mb-3" id="sectionEarnestMoney">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0">3. Earnest Money</h2>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Earnest money is a good-faith deposit made by the buyer to show serious intent to purchase the property.
                    This deposit is typically held by the title company and applied toward the purchase price at closing.
                    Failure to deliver earnest money on time may give the seller the right to cancel the agreement.
                </p>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="earnestMoney" class="form-label">Earnest Money Amount ($)</label>
                        <input type="number" class="form-control" id="earnestMoney" name="earnestMoney" min="0" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="earnestDueDate" class="form-label">Earnest Money Due Date</label>
                        <input type="date" class="form-control" id="earnestDueDate" name="earnestDueDate" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="titleCompany" class="form-label">Title Company (Escrow Agent)</label>
                    <input type="text" class="form-control" id="titleCompany" name="titleCompany" required>
                </div>
            </div>
        </div>

        <!-- Section 4: Contingencies -->
        <div class="card shadow-lg mb-3">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0">4. Contingencies</h2>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Contingencies allow the buyer to cancel or renegotiate the contract based on specific conditions like financing, inspections, or appraisal.
                    If selected, deadlines must be met for each contingency to remain valid.
                </p>

                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="inspectionContingency" name="contingencies" value="inspection">
                    <label class="form-check-label" for="inspectionContingency">
                        Inspection Contingency
                    </label>
                    <div class="ms-4 mt-2">
                        <label for="inspectionDeadlineDays" class="form-label">Inspection Deadline (Usually 10–15 days)</label>
                        <input type="number" class="form-control" name="inspectionDeadlineDays" id="inspectionDeadlineDays" min="1">
                    </div>
                </div>

                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="appraisalContingency" name="contingencies" value="appraisal">
                    <label class="form-check-label" for="appraisalContingency">
                        Appraisal Contingency
                    </label>
                    <div class="ms-4 mt-2">
                        <label for="appraisalDeadlineDays" class="form-label">Appraisal Deadline (Typically 25–30 days)</label>
                        <input type="number" class="form-control" name="appraisalDeadlineDays" id="appraisalDeadlineDays" min="1">
                    </div>
                </div>

                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="financingContingency" name="contingencies" value="financing">
                    <label class="form-check-label" for="financingContingency">
                        Financing Contingency
                    </label>
                    <div class="ms-4 mt-2">
                        <label for="loanApprovalDeadlineDays" class="form-label">Loan Approval Deadline (Usually 25–33 days)</label>
                        <input type="number" class="form-control" name="loanApprovalDeadlineDays" id="loanApprovalDeadlineDays" min="1">
                    </div>
                </div>
            </div>
        </div>
                        
<!-- Section 5: Additional Documents and Riders -->
<div class="card shadow-lg mb-3">
    <div class="card-header bg-primary text-white">
      <h2 class="h4 mb-0">5. Additional Documents and Riders</h2>
    </div>
    <div class="card-body">
      <p class="text-muted mb-3">
        Select additional documents and riders to include with your offer. Some riders are required. Riders are viewable in the preview at the bottom of the page! 
      </p>
  
      <!-- Required Documents -->
      <div class="mb-4">
        <h6 class="border-bottom pb-2">Required Documents</h6>
  
        <!-- Wire Fraud Advisory -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="wireFraudAdvisory" name="riders.wireFraudAdvisory.acknowledged" checked disabled>
          <label class="form-check-label" for="wireFraudAdvisory">
            Wire Fraud Advisory <span class="badge bg-danger ms-2">Required</span>
          </label>
          <div class="form-text">
            This document warns about wire fraud risks in real estate transactions and provides guidance on secure fund transfers.
          </div>
          <div class="form-check mt-2 ms-4">
            <input class="form-check-input" type="checkbox" id="wireFraudAcknowledgment" name="riders.wireFraudAdvisory.acknowledged" required>
            <label class="form-check-label" for="wireFraudAcknowledgment">
              I acknowledge that I have read and understand the Wire Fraud Advisory
            </label>
          </div>
        </div>
  
        <!-- Home Inspection Advisory -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="homeInspectionAdvisory" name="riders.homeInspectionAdvisory.acknowledged" checked disabled>
          <label class="form-check-label" for="homeInspectionAdvisory">
            Home Inspection Advisory <span class="badge bg-danger ms-2">Required</span>
          </label>
          <div class="form-text">
            This document explains the importance of getting a professional home inspection before completing your purchase.
          </div>
          <div class="form-check mt-2 ms-4">
            <input class="form-check-input" type="checkbox" id="homeInspectionAcknowledgment" name="riders.homeInspectionAdvisory.acknowledged" required>
            <label class="form-check-label" for="homeInspectionAcknowledgment">
              I acknowledge that I have read and understand the Home Inspection Advisory
            </label>
          </div>
        </div>
  
        <!-- Platform Fee Disclosure -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="feeRider" name="riders.fee.included" checked disabled>
          <label class="form-check-label" for="feeRider">
            Platform Fee Disclosure <span class="badge bg-danger ms-2">Required</span>
          </label>
          <div class="form-text">
            This document discloses the platform fees associated with this transaction.
          </div>
          <div class="form-check mt-2 ms-4">
            <input class="form-check-input" type="checkbox" id="feeAcknowledgment" name="riders.fee.feeAcknowledged" required>
            <label class="form-check-label" for="feeAcknowledgment">
              I acknowledge and agree to pay the platform fee of <strong>$<span id="platformFeeAmount">1000</span></strong>
            </label>
            <input type="hidden" name="riders.fee.platformFee" value="1000">
          </div>
        </div>
      </div>
  
      <!-- Optional Riders -->
      <div>
        <h6 class="border-bottom pb-2">Optional Riders</h6>
  
        <!-- Government Loan Rider -->
        <div class="form-check mb-3">
          <input class="form-check-input rider-checkbox" type="checkbox" id="governmentLoanRider" name="riders.governmentLoan.included" data-target="governmentLoanDetails">
          <label class="form-check-label" for="governmentLoanRider">
            Government Loan Rider
          </label>
          <div class="form-text">
            Select this rider if you're using an FHA, VA, or USDA government-backed loan.
          </div>
          <div id="governmentLoanDetails" class="rider-details mt-3 ms-4 p-3 bg-light rounded" style="display: none;">
            <label for="loanTypeRider" class="form-label">Loan Type</label>
            <select class="form-select" name="riders.governmentLoan.loanType" id="loanTypeRider">
              <option value="">Select</option>
              <option value="fha">FHA</option>
              <option value="va">VA</option>
              <option value="usda">USDA</option>
              <option value="other">Other</option>
            </select>
            <div class="row mt-3">
              <div class="col-md-6">
                <label for="loanPercentage" class="form-label">Loan Percentage</label>
                <div class="input-group">
                  <input type="number" class="form-control" name="riders.governmentLoan.loanPercentage" id="loanPercentage">
                  <span class="input-group-text">%</span>
                </div>
              </div>
              <div class="col-md-6">
                <label for="loanContingencyDeadline" class="form-label">Loan Contingency Deadline</label>
                <div class="input-group">
                  <input type="number" class="form-control" name="riders.governmentLoan.loanContingencyDeadline" id="loanContingencyDeadline" value="25">
                  <span class="input-group-text">days</span>
                </div>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Sight Unseen Rider -->
        <div class="form-check mb-3">
          <input class="form-check-input rider-checkbox" type="checkbox" id="sightUnseenRider" name="riders.sightUnseen.included" data-target="sightUnseenDetails">
          <label class="form-check-label" for="sightUnseenRider">Sight Unseen Rider</label>
          <div class="form-text">
            Use if you are submitting an offer without seeing the property in person.
          </div>
          <div id="sightUnseenDetails" class="rider-details mt-3 ms-4 p-3 bg-light rounded" style="display: none;">
            <label class="form-label">Do you reserve the right to view the property before closing?</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="riders.sightUnseen.reserveRightToView" value="true">
              <label class="form-check-label">Yes, I reserve the right</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="riders.sightUnseen.reserveRightToView" value="false" checked>
              <label class="form-check-label">No, I waive the right</label>
            </div>
            <div class="mt-2">
              <label for="propertyViewingPeriod" class="form-label">Viewing Period (days)</label>
              <input type="number" class="form-control" id="propertyViewingPeriod" name="riders.sightUnseen.propertyViewingPeriod" value="5" min="1" max="14">
            </div>
          </div>
        </div>
  
        <!-- Contingency for Sale Rider -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="contingencyForSale" name="riders.contingencyForSale.included">
          <label class="form-check-label" for="contingencyForSale">
            Contingency for Sale of Buyer's Existing Property
          </label>
        </div>
  
        <!-- Contingency for Closing Rider -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="contingencyForClosing" name="riders.contingencyForClosing.included">
          <label class="form-check-label" for="contingencyForClosing">
            Contingency for Closing of Buyer's Existing Property
          </label>
        </div>
      </div>
    </div>
  </div>

<!-- Section 6: Closing Details -->
<div class="card shadow-lg mb-4">
    <div class="card-header bg-primary text-white">
      <h2 class="h4 mb-0">6. Closing Details</h2>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="closingDate" class="form-label">
            Proposed Closing Date
            <small class="text-muted d-block">(Date you want to sign documents and take control of the property)</small>
          </label>
          <input type="date" class="form-control" id="closingDate" name="closingDate" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="titleCompany" class="form-label">
            Title Company
            <small class="text-muted d-block">(Company that processes documents for closing)</small>
          </label>
          <select id="titleCompany" name="titleCompany" class="form-select" required>
            <option value="">Select Title Company</option>
            <% if (titleCompanies && titleCompanies.length > 0) { %>
              <% titleCompanies.forEach(company => { %>
                <option value="<%= company.companyName %>" data-address="<%= company.address %>">
                  <%= company.companyName %>
                </option>
              <% }); %>
            <% } %>
          </select>
          <input type="hidden" id="titleCompanyAddress" name="titleCompanyAddress">
        </div>
      </div>
      <div class="mb-4">
        <label class="form-label">
          Closing Costs Allocation
          <small class="text-muted d-block">(Defines who is responsible for closing costs)</small>
        </label>
        <div class="row">
    <div class="col-md-6">
      <div class="form-check mb-3">
        <input type="radio" class="form-check-input" name="closingCosts" id="buyerPays" value="buyer" required>
        <label class="form-check-label" for="buyerPays">
          Buyer Pays All
          <small class="d-block text-muted">(Buyer pays all closing costs from both sides)</small>
        </label>
      </div>
      <div class="form-check mb-3">
        <input type="radio" class="form-check-input" name="closingCosts" id="splitCosts" value="split">
        <label class="form-check-label" for="splitCosts">
          Split Costs
          <small class="d-block text-muted">(Even 50/50 split)</small>
        </label>
      </div>
    </div>
    <div class="col-md-6">
      <div class="form-check mb-3">
        <input type="radio" class="form-check-input" name="closingCosts" id="sellerPays" value="seller">
        <label class="form-check-label" for="sellerPays">
          Seller Pays All
          <small class="d-block text-muted">(Seller pays all closing costs from both sides)</small>
        </label>
      </div>
      <div class="form-check mb-3">
        <input type="radio" class="form-check-input" name="closingCosts" id="each_pays_own" value="each_pays_own">
        <label class="form-check-label" for="each_pays_own">
          Each Pays Own
          <small class="d-block text-muted">(Buyer & Seller each pay their own; concessions may apply)</small>
        </label>
      </div>
    </div>
  </div>
      </div>
      <div class="col-md-6 mb-3">
        <label for="maxConcession" class="form-label">
          Max Concession Amount ($)
          <small class="text-muted d-block">(Max the seller will contribute toward concessions, including closing costs)</small>
        </label>
        <input type="number" class="form-control" id="maxConcession" name="maxConcession" required>
      </div>
    </div>
  </div>
  
        <!-- Section 7: Acknowledgments -->
<div class="card shadow-lg mb-3">
    <div class="card-header bg-primary text-white">
      <h2 class="h4 mb-0">7. Acknowledgments</h2>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <label class="form-label">Was this property built before 1978?</label>
            <div class="row">
              <div class="col-md-1">
                <div class="form-check">
                  <input type="radio" class="form-check-input" name="preseventyEightProperty" id="preseventyEightYes" value="yes">
                  <label class="form-check-label" for="preseventyEightYes">Yes</label>
                </div>
              </div>
              <div class="col-md-1">
                <div class="form-check">
                  <input type="radio" class="form-check-input" name="preseventyEightProperty" id="preseventyEightNo" value="no">
                  <label class="form-check-label" for="preseventyEightNo">No</label>
                </div>
              </div>
            </div>
          </div>
      <div id="leadBasedPaintSection" style="display:none;">
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="sellerLeadDisclosure" name="sellerLeadDisclosure" required>
          <label class="form-check-label" for="sellerLeadDisclosure">
            Seller to provide a lead based paint disclosure within 3 days of acceptance of agreement.
          </label>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="buyerLeadInspection" name="buyerLeadInspection">
          <label class="form-check-label" for="buyerLeadInspection">
            Buyer has the right to conduct a lead-based paint inspection at their own expense
          </label>
        </div>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="legalAcknowledgment" name="acknowledgment" value="true" required>
        <label class="form-check-label" for="legalAcknowledgment">
          I acknowledge this is a legally binding contract and understand its implications
        </label>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="documentAgreement" name="agreeDocuments" value="true" required>
        <label class="form-check-label" for="documentAgreement">
          I agree to provide all necessary documents as requested
        </label>
      </div>
    </div>
  </div>
  
    
        <!-- Form Actions -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-3">
            <button type="button" class="btn btn-secondary" id="previewContractBtn">
                Preview Contract
            </button>
            <button type="submit" class="btn btn-primary">
                Submit Offer
            </button>
        </div>
    </form>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const preseventyEightRadios = document.querySelectorAll('input[name="preseventyEightProperty"]');
        const leadBasedPaintSection = document.getElementById('leadBasedPaintSection');
        const sellerLeadDisclosure = document.getElementById('sellerLeadDisclosure');

        preseventyEightRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'yes') {
                    leadBasedPaintSection.style.display = 'block';
                    sellerLeadDisclosure.setAttribute('required', '');
                } else {
                    leadBasedPaintSection.style.display = 'none';
                    sellerLeadDisclosure.removeAttribute('required');
                    sellerLeadDisclosure.checked = false;
                }
            });
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Financing Method Conditional Fields
    const financingRadios = document.querySelectorAll('input[name="financingType"]');
    const bankFinancingDetails = document.getElementById('bankFinancingDetails');

    financingRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            bankFinancingDetails.style.display = 
                this.value === 'bank' ? 'flex' : 'none';
            
            // Reset or disable fields when not selected
            if (this.value !== 'bank') {
                document.getElementById('loanType').value = '';
                document.getElementById('loanAmount').value = '';
                document.getElementById('interestRate').value = '';
            }
        });
    });

    // Contingency Checkboxes
    const contingencyCheckboxes = document.querySelectorAll('.contingency-checkbox');
    
    contingencyCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const detailsId = this.id.replace('Contingency', 'Details');
            const detailsDiv = document.getElementById(detailsId);
            
            if (detailsDiv) {
                detailsDiv.style.display = this.checked ? 'block' : 'none';
                
                // Reset input when unchecked
                if (!this.checked) {
                    const inputs = detailsDiv.querySelectorAll('input');
                    inputs.forEach(input => input.value = '');
                }
            }
        });
    });
    
    // Price Validation
    const offerPriceInput = document.getElementById('offerPrice');
    const listingPrice = <%= listing.price %>;
    
    offerPriceInput.addEventListener('input', function() {
        const minPrice = Math.round(listingPrice * 0.5);
        const maxPrice = Math.round(listingPrice * 1.5);
        
        if (this.value < minPrice || this.value > maxPrice) {
            this.setCustomValidity(`Offer price must be between $${minPrice.toLocaleString()} and $${maxPrice.toLocaleString()}`);
        } else {
            this.setCustomValidity('');
        }
    });

    // Closing Date Validation
    const closingDateInput = document.getElementById('closingDate');
    const today = new Date();
    const maxClosingDate = new Date();
    maxClosingDate.setMonth(today.getMonth() + 6); // 6 months from now

    closingDateInput.min = today.toISOString().split('T')[0];
    closingDateInput.max = maxClosingDate.toISOString().split('T')[0];

    // Form Submission Handler
    document.getElementById('offerForm').addEventListener('submit', function(event) {
        // Additional form validation
        const financingType = document.querySelector('input[name="financingType"]:checked');
        
        if (!financingType) {
            event.preventDefault();
            alert('Please select a financing method');
            return;
        }

        // Clear any potentially problematic required attributes
        document.querySelectorAll('.rider-details:not(:visible) [required]').forEach(field => {
            field.removeAttribute('required');
        });
        
        document.querySelectorAll('[id$="Details"]:not(:visible) [required]').forEach(field => {
            field.removeAttribute('required');
        });
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle rider checkbox changes
        const riderCheckboxes = document.querySelectorAll('.rider-checkbox');
        
        riderCheckboxes.forEach(checkbox => {
            const targetId = checkbox.dataset.target;
            const targetDiv = document.getElementById(targetId);
            
            if (targetDiv) {
                if (checkbox.checked) {
                    targetDiv.style.display = 'block';
                } else {
                    targetDiv.style.display = 'none';
                    // Remove required attribute from all fields in this section
                    const requiredFields = targetDiv.querySelectorAll('[required]');
                    requiredFields.forEach(field => {
                        field.removeAttribute('required');
                    });
                }
                
                checkbox.addEventListener('change', function() {
                    const targetId = this.dataset.target;
                    const targetDiv = document.getElementById(targetId);
                    
                    if (targetDiv) {
                        if (this.checked) {
                            targetDiv.style.display = 'block';
                            // Enable required on needed fields
                            const inputs = targetDiv.querySelectorAll('[data-required="true"]');
                            inputs.forEach(input => input.setAttribute('required', ''));
                        } else {
                            targetDiv.style.display = 'none';
                            // Remove required attribute
                            const inputs = targetDiv.querySelectorAll('[required]');
                            inputs.forEach(input => input.removeAttribute('required'));
                        }
                    }
                });
            }
        });
    });
</script>

<!-- Script for contract preview -->
<script>
    // Preview Contract Function
    document.getElementById('previewContractBtn').addEventListener('click', function(event) {
        event.preventDefault();
        
        const form = document.getElementById('offerForm');
        
        // Remove required from hidden sections before validation
        document.querySelectorAll('.rider-details').forEach(details => {
        // Check if the element is hidden using its display style
            if (window.getComputedStyle(details).display === 'none') {
                // Find required fields within this hidden details section
                details.querySelectorAll('[required]').forEach(field => {
                    field.removeAttribute('required');
                });
            }
        });
        
        document.querySelectorAll('[id$="Details"]').forEach(details => {
            // Check if the element is hidden using its display style
            if (window.getComputedStyle(details).display === 'none') {
                // Find required fields within this hidden details section
                details.querySelectorAll('[required]').forEach(field => {
                    field.removeAttribute('required');
                });
            }
        });
            
        // Check if the form is valid
        if (form.checkValidity()) {
            // Create form data for the preview
            const formData = new FormData(form);
            const queryString = new URLSearchParams(formData).toString();
            
            // Open preview in a new window
            window.open(`/offers/preview?${queryString}`, '_blank');
        } else {
            // Show validation messages
            form.reportValidity();
        }
    });

    document.getElementById('titleCompany').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const address = selectedOption.dataset.address || '';
        document.getElementById('titleCompanyAddress').value = address;
    });
</script>

<script src="/js/riderValidation.js"></script>
<script src="/js/riderPreview.js"></script>
<%- include('../partials/footer.ejs') %>